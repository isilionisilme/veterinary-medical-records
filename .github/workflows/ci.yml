name: CI

on:
  push:
    branches: [main]

  pull_request:
    branches: [main]

jobs:
  doc_test_sync_guard:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Run doc/test sync guard
        run: |
          python scripts/check_doc_test_sync.py --base-ref "${{ github.event.pull_request.base.sha }}"
      - name: Run doc/router parity guard
        run: |
          python scripts/check_doc_router_parity.py --base-ref "${{ github.event.pull_request.base.sha }}"

  brand_guard:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Run brand compliance guard (frontend added lines)
        run: |
          python scripts/check_brand_compliance.py --base-ref "${{ github.event.pull_request.base.sha }}"

  frontend_design_system_guard:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install frontend dependencies
        run: npm --prefix frontend ci
      - name: Run design system guard
        run: npm --prefix frontend run check:design-system

  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Run Ruff
        run: ruff check .
      - name: Run Pytest
        run: pytest

  docker_packaging_guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Detect Docker packaging-related changes
        id: packaging_changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docker_packaging:
              - ".dockerignore"
              - ".env.example"
              - "Dockerfile.backend"
              - "Dockerfile.frontend"
              - "docker-compose.yml"
              - "docker-compose.dev.yml"
              - ".github/workflows/ci.yml"
              - "shared/**"
              - "backend/**"
              - "frontend/**"
      - name: Build backend image
        if: steps.packaging_changes.outputs.docker_packaging == 'true'
        run: docker build -f Dockerfile.backend -t vetrecords-backend:ci .
      - name: Assert shared contract exists in backend image (no shell dependency)
        if: steps.packaging_changes.outputs.docker_packaging == 'true'
        run: |
          set -euo pipefail
          cid="$(docker create vetrecords-backend:ci)"
          trap 'docker rm -f "$cid" >/dev/null 2>&1 || true' EXIT
          docker cp "$cid:/app/shared/global_schema_v0_contract.json" /tmp/backend_global_schema_v0_contract.json
          test -f /tmp/backend_global_schema_v0_contract.json
      - name: Build frontend image
        if: steps.packaging_changes.outputs.docker_packaging == 'true'
        run: docker build -f Dockerfile.frontend -t vetrecords-frontend:ci .
      - name: Assert shared contract exists in frontend image (no shell dependency)
        if: steps.packaging_changes.outputs.docker_packaging == 'true'
        run: |
          set -euo pipefail
          cid="$(docker create vetrecords-frontend:ci)"
          trap 'docker rm -f "$cid" >/dev/null 2>&1 || true' EXIT
          docker cp "$cid:/app/shared/global_schema_v0_contract.json" /tmp/frontend_global_schema_v0_contract.json
          test -f /tmp/frontend_global_schema_v0_contract.json
      - name: Docker packaging guard skipped (no relevant changes)
        if: steps.packaging_changes.outputs.docker_packaging != 'true'
        run: echo "No Docker packaging-relevant changes detected; skipping Docker image guard."
