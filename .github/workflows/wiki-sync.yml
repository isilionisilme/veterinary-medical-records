name: Wiki Sync

on:
  push:
    branches: [main]
    paths:
      - "README.md"
      - "docs/README.md"
      - "docs/projects/veterinary-medical-records/**"
      - "docs/shared/**"
      - "scripts/sync_docs_to_wiki.py"
      - ".github/workflows/wiki-sync.yml"
  workflow_dispatch:

concurrency:
  group: wiki-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Clone wiki repository
        env:
          WIKI_PUSH_TOKEN: ${{ secrets.WIKI_PUSH_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          if [ -z "${WIKI_PUSH_TOKEN}" ]; then
            echo "WIKI_PUSH_TOKEN secret is required."
            exit 1
          fi
          git clone "https://x-access-token:${WIKI_PUSH_TOKEN}@github.com/${REPO}.wiki.git" wiki-repo

      - name: Generate wiki pages from canonical docs
        run: |
          python scripts/sync_docs_to_wiki.py \
            --wiki-dir wiki-repo \
            --repo "${{ github.repository }}" \
            --ref "${{ github.ref_name }}"

      - name: Commit and push wiki changes
        env:
          WIKI_PUSH_TOKEN: ${{ secrets.WIKI_PUSH_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          cd wiki-repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -z "$(git status --porcelain)" ]; then
            echo "No wiki changes detected."
            exit 0
          fi

          git add .
          git commit -m "docs(wiki): sync from canonical docs"
          git push "https://x-access-token:${WIKI_PUSH_TOKEN}@github.com/${REPO}.wiki.git" HEAD:master